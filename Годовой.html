<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥: –ê–Ω–∞–ª–∏–∑ —Å–∫–ª–∞–¥–∞ "–í–µ—Ä—Ö–æ–≤—å–µ"</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f7fa;
            --text-color: #333;
            --card-bg: white;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --filter-bg: white;
            --border-color: #ddd;
            --primary-color: #3498db;
            --hover-color: #2980b9;
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --card-bg: #2d2d2d;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.3);
            --filter-bg: #3d3d3d;
            --border-color: #555;
            --primary-color: #4a9fe0;
            --hover-color: #3a8fd0;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .theme-switcher {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-upload {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            text-align: center;
        }

        .filters {
            background: var(--filter-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        select, button {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--hover-color);
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .kpi-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: var(--text-color);
        }

        .kpi-title {
            color: #7f8c8d;
            font-size: 14px;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            height: 350px;
        }

        .chart-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--text-color);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .kpi-cards {
                grid-template-columns: 1fr 1fr;
            }
            
            .charts-row {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>–ê–Ω–∞–ª–∏–∑ —Å–∫–ª–∞–¥–∞ "–í–µ—Ä—Ö–æ–≤—å–µ"</h1>
            <div class="theme-switcher">
                <button class="theme-btn" id="light-theme">
                    <span>‚òÄÔ∏è</span> –°–≤–µ—Ç–ª–∞—è
                </button>
                <button class="theme-btn" id="dark-theme">
                    <span>üåô</span> –¢–µ–º–Ω–∞—è
                </button>
            </div>
        </div>
        
        <div class="file-upload">
            <h3>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö (Excel –∏–ª–∏ CSV)</h3>
            <input type="file" id="file-input" accept=".xlsx,.xls,.csv">
            <button id="load-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label for="year-filter">–ì–æ–¥:</label>
                <select id="year-filter" disabled>
                    <option value="all">–í—Å–µ</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="month-filter">–ú–µ—Å—è—Ü:</label>
                <select id="month-filter" disabled>
                    <option value="all">–í—Å–µ</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="metric-filter">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å:</label>
               <select id="metric-filter" disabled>
    <option value="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—à–∏–Ω">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—à–∏–Ω</option>
    <option value="–í–µ—Å, –∫–≥">–í–µ—Å, –∫–≥</option>
    <option value="–ö–æ–ª-–≤–æ –ø–æ–∑–∏—Ü–∏–π">–ö–æ–ª-–≤–æ –ø–æ–∑–∏—Ü–∏–π</option>
    <option value="–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤">–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤</option>
    <option value="C—Ç–æ–∏–º–æ—Å—Ç—å —Ä—É–±/–ø–æ–∑">C—Ç–æ–∏–º–æ—Å—Ç—å —Ä—É–±/–ø–æ–∑</option>
    <option value="% –æ—Ç –∑–∞–∫–∞–∑–æ–≤">% –æ—Ç –∑–∞–∫–∞–∑–æ–≤</option>
    <option value="% –æ—Ç –º–∞—à–∏–Ω">% –æ—Ç –º–∞—à–∏–Ω</option>
    <option value="–û–±–æ—Ä–æ—Ç —Å–∫–ª–∞–¥ –∫–≥/—á">–û–±–æ—Ä–æ—Ç —Å–∫–ª–∞–¥ –∫–≥/—á</option>
    <option value="–ü–æ–∑–∏—Ü–∏–π –≤ —á–∞—Å">–ü–æ–∑–∏—Ü–∏–π –≤ —á–∞—Å</option>
    <option value="–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞</option>
    <option value="–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏">–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏</option>
</select>
            </div>
        </div>
        
        <div class="kpi-cards">
            <div class="kpi-card">
                <div class="kpi-title">–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—à–∏–Ω</div>
                <div class="kpi-value" id="avg-machines">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–û–±—â–∏–π –≤–µ—Å –≥—Ä—É–∑–æ–≤ (—Ç–æ–Ω–Ω—ã)</div>
                <div class="kpi-value" id="total-weight">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–°—Ä–µ–¥–Ω–∏–π % –ø—Ä–µ—Ç–µ–Ω–∑–∏–π</div>
                <div class="kpi-value" id="avg-claims">-</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">–°—Ä–µ–¥–Ω–∏–π –æ–±–æ—Ä–æ—Ç (–∫–≥/—á)</div>
                <div class="kpi-value" id="avg-turnover">-</div>
            </div>
        </div>
        
        <div class="charts-row">
            <div class="chart-container">
                <h3 class="chart-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è</h3>
                <canvas id="mainChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</h3>
                <div id="comparisonChart" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
        
        <div class="charts-row">
            <div class="chart-container">
                <h3 class="chart-title">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∫–ª–∞–¥–∞</h3>
                <canvas id="efficiencyChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏</h3>
                <div id="problemsChart" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        let rawData = [];
        let processedData = [];
        let mainChart, efficiencyChart;
        const comparisonChart = echarts.init(document.getElementById('comparisonChart'));
        const problemsChart = echarts.init(document.getElementById('problemsChart'));
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const fileInput = document.getElementById('file-input');
        const loadBtn = document.getElementById('load-btn');
        const loadingIndicator = document.getElementById('loading');
        const yearFilter = document.getElementById('year-filter');
        const monthFilter = document.getElementById('month-filter');
        const metricFilter = document.getElementById('metric-filter');
        const lightThemeBtn = document.getElementById('light-theme');
        const darkThemeBtn = document.getElementById('dark-theme');

        // –ú–µ—Å—è—Ü–∞ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        const monthsOrder = {
            "–Ø–Ω–≤–∞—Ä—å": 1, "–§–µ–≤—Ä–∞–ª—å": 2, "–ú–∞—Ä—Ç": 3, "–ê–ø—Ä–µ–ª—å": 4, "–ú–∞–π": 5, "–ò—é–Ω—å": 6,
            "–ò—é–ª—å": 7, "–ê–≤–≥—É—Å—Ç": 8, "–°–µ–Ω—Ç—è–±—Ä—å": 9, "–û–∫—Ç—è–±—Ä—å": 10, "–ù–æ—è–±—Ä—å": 11, "–î–µ–∫–∞–±—Ä—å": 12
        };

        // –¶–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        const chartColors = [
            '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', 
            '#1abc9c', '#d35400', '#34495e', '#16a085', '#c0392b'
        ];

        // –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
        function setTheme(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
            updateCharts(filterData());
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            setTheme(true);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–º
        lightThemeBtn.addEventListener('click', () => setTheme(false));
        darkThemeBtn.addEventListener('click', () => setTheme(true));

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        loadBtn.addEventListener('click', function() {
            const file = fileInput.files[0];
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }
            
            loadingIndicator.style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Å—Ç–∞
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JSON
                    rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    processData();
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                    yearFilter.disabled = false;
                    monthFilter.disabled = false;
                    metricFilter.disabled = false;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    updateFilters();
                    const filteredData = filterData();
                    updateKPIs(filteredData);
                    updateCharts(filteredData);
                    
                    loadingIndicator.style.display = 'none';
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö.');
                    loadingIndicator.style.display = 'none';
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        function processData() {
            // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
            const headers = rawData[0];
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            processedData = [];
            for (let i = 1; i < rawData.length; i++) {
                const row = rawData[i];
                if (row.length === 0) continue;
                
                const item = {};
                for (let j = 0; j < headers.length; j++) {
                    item[headers[j]] = row[j];
                }
                processedData.push(item);
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ–¥—É –∏ –º–µ—Å—è—Ü—É
            processedData.sort((a, b) => {
                if (a.–ì–æ–¥ !== b.–ì–æ–¥) return a.–ì–æ–¥ - b.–ì–æ–¥;
                return monthsOrder[a.–ú–µ—Å—è—Ü] - monthsOrder[b.–ú–µ—Å—è—Ü];
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateFilters() {
            // –ì–æ–¥—ã
            const years = [...new Set(processedData.map(item => item.–ì–æ–¥))].sort();
            yearFilter.innerHTML = '<option value="all">–í—Å–µ</option>';
            years.forEach(year => {
                yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
            });
            
            // –ú–µ—Å—è—Ü—ã
            const months = [...new Set(processedData.map(item => item.–ú–µ—Å—è—Ü))].sort((a, b) => {
                return monthsOrder[a] - monthsOrder[b];
            });
            monthFilter.innerHTML = '<option value="all">–í—Å–µ</option>';
            months.forEach(month => {
                monthFilter.innerHTML += `<option value="${monthsOrder[month]}">${month}</option>`;
            });
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
        function filterData() {
            const year = yearFilter.value;
            const month = monthFilter.value;
            const metric = metricFilter.value;
            
            return processedData.filter(item => {
                return (year === 'all' || item.–ì–æ–¥.toString() === year) &&
                       (month === 'all' || monthsOrder[item.–ú–µ—Å—è—Ü].toString() === month) &&
                       (item.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === metric);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è KPI
        function updateKPIs(filteredData) {
            if (processedData.length === 0) return;
            
            try {
                // –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—à–∏–Ω
                const machines = processedData.filter(d => d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—à–∏–Ω").map(d => d["–ö–æ–ª-–≤–æ"]);
                const avgMachines = (machines.reduce((a, b) => a + b, 0) / machines.length).toFixed(0);
                document.getElementById('avg-machines').textContent = avgMachines;
                
                // –û–±—â–∏–π –≤–µ—Å –≥—Ä—É–∑–æ–≤ (–≤ —Ç–æ–Ω–Ω–∞—Ö)
                const weights = processedData.filter(d => d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "–í–µ—Å, –∫–≥").map(d => d["–ö–æ–ª-–≤–æ"]);
                const totalWeight = weights.length > 0 ? (weights.reduce((a, b) => a + b, 0) / 1000).toFixed(0) : 0;
                document.getElementById('total-weight').textContent = totalWeight + " —Ç";
                
                // –°—Ä–µ–¥–Ω–∏–π % –ø—Ä–µ—Ç–µ–Ω–∑–∏–π
                const claims = processedData.filter(d => d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "% –æ—Ç –∑–∞–∫–∞–∑–æ–≤").map(d => d["–ö–æ–ª-–≤–æ"]);
                const avgClaims = claims.length > 0 ? (claims.reduce((a, b) => a + b, 0) / claims.length).toFixed(2) : 0;
                document.getElementById('avg-claims').textContent = avgClaims + "%";
                
                // –°—Ä–µ–¥–Ω–∏–π –æ–±–æ—Ä–æ—Ç
                const turnovers = processedData.filter(d => d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "–û–±–æ—Ä–æ—Ç —Å–∫–ª–∞–¥ –∫–≥/—á").map(d => d["–ö–æ–ª-–≤–æ"]);
                const avgTurnover = turnovers.length > 0 ? (turnovers.reduce((a, b) => a + b, 0) / turnovers.length).toFixed(1) : 0;
                document.getElementById('avg-turnover').textContent = avgTurnover;
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ KPI:", e);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function updateCharts(filteredData) {
            if (processedData.length === 0) return;
            
            try {
                // –†–∞–∑—Ä—É—à–∞–µ–º —Å—Ç–∞—Ä—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                if (mainChart) mainChart.destroy();
                if (efficiencyChart) efficiencyChart.destroy();
                
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–µ—Å—è—Ü—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö
                const allMonths = [...new Set(processedData.map(item => item.–ú–µ—Å—è—Ü))].sort((a, b) => {
                    return monthsOrder[a] - monthsOrder[b];
                });
                
                const metric = metricFilter.value;
                
                // –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ (–ª–∏–Ω–µ–π–Ω—ã–π)
                const mainValues = allMonths.map(month => {
                    const item = filteredData.find(d => d.–ú–µ—Å—è—Ü === month);
                    return item ? item["–ö–æ–ª-–≤–æ"] : 0;
                });
                
                const mainCtx = document.getElementById('mainChart').getContext('2d');
                mainChart = new Chart(mainCtx, {
                    type: 'line',
                    data: {
                        labels: allMonths,
                        datasets: [{
                            label: metric,
                            data: mainValues,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
                
                // –ì—Ä–∞—Ñ–∏–∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (—Å—Ç–æ–ª–±—á–∞—Ç—ã–π —Å –ª–∏–Ω–∏–µ–π)
                const turnoverData = allMonths.map(month => {
                    const item = processedData.find(d => 
                        (yearFilter.value === 'all' || d.–ì–æ–¥.toString() === yearFilter.value) &&
                        (monthFilter.value === 'all' || monthsOrder[d.–ú–µ—Å—è—Ü].toString() === monthFilter.value) &&
                        d.–ú–µ—Å—è—Ü === month && 
                        d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "–û–±–æ—Ä–æ—Ç —Å–∫–ª–∞–¥ –∫–≥/—á"
                    );
                    return item ? item["–ö–æ–ª-–≤–æ"] : 0;
                });
                
                const positionsData = allMonths.map(month => {
                    const item = processedData.find(d => 
                        (yearFilter.value === 'all' || d.–ì–æ–¥.toString() === yearFilter.value) &&
                        (monthFilter.value === 'all' || monthsOrder[d.–ú–µ—Å—è—Ü].toString() === monthFilter.value) &&
                        d.–ú–µ—Å—è—Ü === month && 
                        d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "–ü–æ–∑–∏—Ü–∏–π –≤ —á–∞—Å"
                    );
                    return item ? item["–ö–æ–ª-–≤–æ"] : 0;
                });
                
                const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
                efficiencyChart = new Chart(efficiencyCtx, {
                    type: 'bar',
                    data: {
                        labels: allMonths,
                        datasets: [
                            {
                                label: '–û–±–æ—Ä–æ—Ç (–∫–≥/—á)',
                                data: turnoverData,
                                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                                yAxisID: 'y'
                            },
                            {
                                label: '–ü–æ–∑–∏—Ü–∏–π –≤ —á–∞—Å',
                                data: positionsData,
                                borderColor: 'rgb(255, 99, 132)',
                                backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                type: 'line',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '–û–±–æ—Ä–æ—Ç (–∫–≥/—á)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    drawOnChartArea: false
                                },
                                title: {
                                    display: true,
                                    text: '–ü–æ–∑–∏—Ü–∏–π –≤ —á–∞—Å'
                                }
                            }
                        }
                    }
                });
                
                // –ì—Ä–∞—Ñ–∏–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (ECharts)
                const years = [...new Set(processedData.map(item => item.–ì–æ–¥))].sort();
                
                comparisonChart.setOption({
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: years.map(y => y.toString()),
                        textStyle: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: allMonths,
                        axisLabel: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    series: years.map((year, index) => ({
                        name: year,
                        type: 'bar',
                        data: allMonths.map(month => {
                            const item = processedData.find(d => d.–ì–æ–¥.toString() === year.toString() && 
                                                                 d.–ú–µ—Å—è—Ü === month && 
                                                                 d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === metric);
                            return item ? item["–ö–æ–ª-–≤–æ"] : 0;
                        }),
                        itemStyle: {
                            color: chartColors[index % chartColors.length]
                        }
                    }))
                });

                // –ì—Ä–∞—Ñ–∏–∫ "–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏" (ECharts)
                problemsChart.setOption({
                    tooltip: {
                        trigger: 'axis'
                    },
                    legend: {
                        data: ['–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞', '% –æ—Ç –∑–∞–∫–∞–∑–æ–≤'],
                        textStyle: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    xAxis: {
                        type: 'category',
                        data: allMonths,
                        axisLabel: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    yAxis: {
                        type: 'value',
                        axisLabel: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-color')
                        }
                    },
                    series: [
                      {
    name: '–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞',
    type: 'line',
    data: allMonths.map(month => {
        const item = processedData.find(d => 
            (yearFilter.value === 'all' || d.–ì–æ–¥.toString() === yearFilter.value) &&
            d.–ú–µ—Å—è—Ü === month && 
            d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞"
        );
        return item ? item["–ö–æ–ª-–≤–æ"] : 0;
    }),
    smooth: true,
    lineStyle: {
        width: 3,
        color: chartColors[4]
    }
},
                        {
                            name: '% –æ—Ç –∑–∞–∫–∞–∑–æ–≤',
                            type: 'line',
                            data: allMonths.map(month => {
                                const item = processedData.find(d => d.–ú–µ—Å—è—Ü === month && d.–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å === "% –æ—Ç –∑–∞–∫–∞–∑–æ–≤");
                                return item ? item["–ö–æ–ª-–≤–æ"] : 0;
                            }),
                            smooth: true,
                            lineStyle: {
                                width: 3,
                                color: chartColors[1]
                            },
                            itemStyle: {
                                color: chartColors[1]
                            }
                        }
                    ]
                });
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤:", e);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
        yearFilter.addEventListener('change', function() {
            const filteredData = filterData();
            updateCharts(filteredData);
        });
        
        monthFilter.addEventListener('change', function() {
            const filteredData = filterData();
            updateCharts(filteredData);
        });
        
        metricFilter.addEventListener('change', function() {
            const filteredData = filterData();
            updateKPIs(filteredData);
            updateCharts(filteredData);
        });

        // –†–µ—Å–ø–æ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å
        window.addEventListener('resize', function() {
            comparisonChart.resize();
            problemsChart.resize();
        });
    </script>
</body>
</html>